##################################
# Redis 8 container profile
# - Foreground process for s6 supervision
# - Loopback-only binding with protected mode
# - RDB + AOF durability
# - Bounded memory with explicit eviction policy
##################################

########################
# Process / Logging
########################

# s6 needs Redis to stay in the foreground.
daemonize no

# Log to stdout/stderr (container logs). Empty string = stdout.
logfile ""

# Verbosity: debug | verbose | notice | warning
loglevel warning


########################
# Networking / Security
########################

# Listen only on loopback. For remote access, add interfaces and configure ACL/auth.
bind 127.0.0.1
port 6379
protected-mode yes

# TCP keepalive in seconds.
tcp-keepalive 300


########################
# Persistence (RDB + AOF)
########################

# Data directory (must exist and be writable).
dir /data/redis

# RDB snapshots.
dbfilename dump.rdb
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes

# AOF for better durability; fsync every second.
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite yes
auto-aof-rewrite-percentage 50
auto-aof-rewrite-min-size 64mb
aof-use-rdb-preamble yes
aof-load-truncated yes


########################
# Memory / Eviction
########################

# Cap memory to avoid OOM kills; tune to container limits.
maxmemory 256mb

# Eviction policy (Redis 8 default is noeviction):
# - noeviction: fail writes when full (safer for job queues)
# - allkeys-lru / allkeys-lfu: cache-style eviction of any key
# - volatile-lru / volatile-lfu / volatile-ttl / volatile-random: only keys with TTL
maxmemory-policy noeviction
maxmemory-samples 5

# Offload frees to background threads to reduce latency spikes.
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes


########################
# Performance / Clients
########################

# Max client connections (actual cap depends on ulimit).
maxclients 10000

# Optional output buffer safety limits (uncomment if needed).
# client-output-buffer-limit normal 0 0 0
# client-output-buffer-limit pubsub 32mb 8mb 60
# client-output-buffer-limit replica 256mb 64mb 60


########################
# Safety / Reliability
########################

# If background save fails, stop accepting writes to protect persistence.
stop-writes-on-bgsave-error yes

# Reduce hugepages warning noise.
disable-thp yes
